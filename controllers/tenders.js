const fetch = require('node-fetch');

module.exports = { 

    index: async (req, res) => {
        if (!req.isAuthenticated()) {
            res.redirect('/auth/login');
          }
          try {
            let { kwords ,from_date, to_date, status, cust_inn, price1, price2, fz, region} = req.query;
            const encoded = encodeURI(kwords);
            const api_url = `https://damia.ru/api-zakupki/zsearch?q=${encoded}&from_date=${from_date}&region=${region}&to_date=${to_date}&status=${status}&cust_inn=${cust_inn}&min_price=${price1}&max_price=${price2}&fz=${fz}&key=${process.env.damia_key}`;
            const fetch_response = await fetch(api_url);
            const info = await fetch_response.json();
            res.render('tenders', {info, kwords, api_url})
          } catch (error) {
            console.log(error)
          }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
    },
    
    tender: async (req, res) => {
        if (!req.isAuthenticated()) {
            res.redirect('/auth/login');
        }
        let { id } = req.query;
        const api_url_tend = `https://damia.ru/api-zakupki/zakupka?regn=${id}&actual=1&key=${process.env.damia_key}`;
        const fetch_response = await fetch(api_url_tend);
        const tend = await fetch_response.json();
        res.render('tender-page', {tend});
    }
};
